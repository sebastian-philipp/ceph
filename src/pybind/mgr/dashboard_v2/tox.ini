[tox]
envlist = cov-init,ceph-cluster-start,py27,py3,ceph-cluster-stop,cov-report,lint
skipsdist = true

[testenv]
deps=-r{toxinidir}/requirements.txt
setenv=
    UNITTEST=true
    WEBTEST_INTERACTIVE=false
    COVERAGE_FILE= .coverage.{envname}
    PYTHONPATH = {toxinidir}/../../../../build/lib/cython_modules/lib.3:{toxinidir}/../../../../build/lib/cython_modules/lib.2
    LD_LIBRARY_PATH = {toxinidir}/../../../../build/lib
    PATH = {toxinidir}/../../../../build/bin:$PATH
    DASHBOARD_V2_PORT=9865
commands=
    {envbindir}/py.test --cov=. --cov-report= --junitxml=junit.{envname}.xml --doctest-modules controllers/rbd.py tests/

[testenv:cov-init]
setenv =
    COVERAGE_FILE = .coverage
deps = coverage
commands =
    coverage erase

[testenv:ceph-cluster-start]
deps=coverage
changedir={toxinidir}/../../../../build
whitelist_externals=
    bash
    cp
    sleep
    env
    killall
    ./bin/rbd-mirror
setenv=
    COVERAGE_ENABLED=true
    COVERAGE_FILE=.coverage.mgr
commands =
    -killall rbd-mirror
    -bash ../src/mstop.sh primary
    -bash ../src/mstop.sh ceph
    env MGR=1 MDS=0 ../src/mstart.sh primary -n
    cp run/primary/ceph.conf primary.conf
    sleep 20
    env RGW=1 ../src/mstart.sh ceph -n
    cp run/ceph/ceph.conf ceph.conf
    sleep 10
    python ./bin/ceph mgr module disable dashboard_v2
    sleep 5
    python ./bin/ceph config-key set mgr/dashboard_v2/x/server_port 9865
    python ./bin/ceph mgr module enable dashboard_v2
    {toxinidir}/../../../../build/bin/rbd-mirror --log-file=run/ceph/out/rbd-mirror.log
    cp ceph.conf {toxinidir}/
    cp primary.conf {toxinidir}/
    sleep 20

[testenv:ceph-cluster-stop]
deps=
changedir={toxinidir}/../../../../build
whitelist_externals=
    bash
    rm
    mv
    killall
    sleep
commands =
    -killall ceph-mgr rbd-mirror
    sleep 5
    -bash ../src/mstop.sh primary
    -bash ../src/mstop.sh ceph
    rm {toxinidir}/ceph.conf
    mv {toxinidir}/../../../../build/.coverage.mgr {toxinidir}/

[testenv:cov-report]
setenv =
    COVERAGE_FILE = .coverage
deps = coverage
commands =
    coverage combine
    coverage report
    coverage xml

[testenv:lint]
setenv =
    PYTHONPATH = {toxinidir}/../../../../build/lib/cython_modules/lib.3:{toxinidir}/../../../../build/lib/cython_modules/lib.2
    LD_LIBRARY_PATH = {toxinidir}/../../../../build/lib
deps=-r{toxinidir}/requirements.txt
commands=
    pylint --rcfile=.pylintrc --jobs=5 . module.py tools.py controllers models tests services
    pycodestyle --max-line-length=100 --exclude=python2.7,.tox,venv,frontend --ignore=E402,E121,E123,E126,E226,E24,E704,W503 .
